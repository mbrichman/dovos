{% extends "base.html" %}

{% block title %}Stats - ChatGPT Search{% endblock %}

{% block page_title %}Database Statistics{% endblock %}

{% block page_styles %}
    .stats-card {
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .equal-height-row {
        display: flex;
        flex-wrap: wrap;
    }
    .equal-height-row > [class*='col-'] {
        display: flex;
        flex-direction: column;
    }
    .equal-height-row .stats-card {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .equal-height-row .card-body {
        flex: 1;
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #17a2b8;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 1rem;
    }
    .source-badge {
        display: inline-block;
        padding: 0.35rem 0.65rem;
        font-size: 0.85rem;
        font-weight: 500;
        border-radius: 0.25rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .source-chatgpt {
        background-color: #e8f0f8;
        color: #668fe0;
    }
    .source-claude {
        background-color: #f0ecf8;
        color: #876bc1;
    }
    .source-openwebui {
        background-color: #fef4f0;
        color: #f08f75;
    }
    .source-json {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    .source-docx {
        background-color: #f0f9ff;
        color: #0dcaf0;
    }
    .source-unknown {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    .date-range-box {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .date-range-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    .date-range-label {
        font-weight: bold;
        color: #495057;
    }
    .date-range-value {
        color: #17a2b8;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .stat-value {
            font-size: 2rem;
        }
        .stat-label {
            font-size: 0.8rem;
        }
        .chart-container {
            height: 200px;
        }
        .source-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .date-range-box {
            padding: 0.75rem;
        }
        .date-range-item {
            flex-direction: column;
            gap: 0.1rem;
        }
        .empty-state {
            padding: 2rem 1rem;
        }
        .empty-state-icon {
            font-size: 2rem;
        }
    }
    
    @media (max-width: 576px) {
        .chart-container {
            height: 180px;
        }
        .stat-value {
            font-size: 1.75rem;
        }
        .source-badge {
            display: block;
            margin-bottom: 0.25rem;
            text-align: center;
        }
    }
    
    @media (max-width: 400px) {
        .chart-container {
            height: 150px;
        }
    }
{% endblock %}

{% block content %}
{% if stats and stats.total_conversations and stats.total_conversations > 0 %}
    <!-- Summary Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stat-value">{{ stats.total_conversations }}</div>
                    <div class="stat-label">Conversations</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stat-value">{{ stats.total_messages }}</div>
                    <div class="stat-label">Messages</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stat-value">{{ stats.total_embeddings }}</div>
                    <div class="stat-label">Embeddings</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stat-value">{{ "%.1f"|format(stats.embedding_coverage_percent) }}%</div>
                    <div class="stat-label">Embedding Coverage</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 equal-height-row">
        <!-- Document Sources Chart -->
        <div class="col-md-6">
            <div class="card stats-card">
                <div class="card-header">
                    <h5 class="mb-0">Document Sources</h5>
                </div>
                <div class="card-body">
                    {% if stats.sources %}
                        <div class="chart-container">
                            <canvas id="sourcesChart"></canvas>
                        </div>

                        <div class="source-list mt-3">
                            {% for source, count in stats.sources.items() %}
                                <div class="source-badge source-{{ source }}">
                                    {% if source|lower == 'chatgpt' %}
                                        ChatGPT
                                    {% elif source|lower == 'openwebui' %}
                                        OpenWebUI
                                    {% else %}
                                        {{ source|capitalize }}
                                    {% endif %}: {{ count }}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No source information available</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Date Range -->
        <div class="col-md-6">
            <div class="card stats-card">
                <div class="card-header">
                    <h5 class="mb-0">Document Timeline</h5>
                </div>
                <div class="card-body">
                    {% if stats.date_range %}
                        <div class="date-range-box">
                            <div class="date-range-item">
                                <span class="date-range-label">Earliest Document:</span>
                                <span class="date-range-value date-to-format">{{ stats.date_range.earliest }}</span>
                            </div>
                            <div class="date-range-item">
                                <span class="date-range-label">Latest Document:</span>
                                <span class="date-range-value date-to-format">{{ stats.date_range.latest }}</span>
                            </div>
                            <div class="date-range-item">
                                <span class="date-range-label">Time Span:</span>
                                <span class="date-range-value" id="timeSpan">Calculating...</span>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">No date information available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Collection Information -->
    {% if stats.collection_info %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-header">
                    <h5 class="mb-0">Collection Information</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li><strong>Collection Name:</strong> {{ stats.collection_name }}</li>
                        <li><strong>Embedding Model:</strong> {{ stats.embedding_model }}</li>
                        <li><strong>Vector Dimensions:</strong> {{ stats.collection_info.dimensions }}</li>
                        {% if stats.collection_info.last_updated %}
                        <li><strong>Last Updated:</strong> <span class="date-to-format">{{ stats.collection_info.last_updated }}</span></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“Š</div>
        <h3>No Documents Indexed Yet</h3>
        <p>Upload some ChatGPT conversations or Word documents to see statistics.</p>
        <a href="/upload" class="btn btn-primary mt-3">Upload Documents</a>
    </div>
{% endif %}
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if stats and stats.total_conversations and stats.total_conversations > 0 %}
            // Format dates
            formatDates();

            // Calculate time span
            calculateTimeSpan();

            // Initialize charts
            initializeSourcesChart();

            {% if stats.timeline %}
                initializeTimelineChart();
            {% endif %}
        {% endif %}
    });
    
    function formatDates() {
        const dateElements = document.querySelectorAll('.date-to-format');
        
        dateElements.forEach(function(element) {
            const dateStr = element.textContent.trim();
            const formattedDate = formatDateNicely(dateStr);
            element.textContent = formattedDate;
        });
    }
    
    function calculateTimeSpan() {
        {% if stats and stats.date_range %}
            const earliestDate = new Date("{{ stats.date_range.earliest }}");
            const latestDate = new Date("{{ stats.date_range.latest }}");
            
            if (isNaN(earliestDate.getTime()) || isNaN(latestDate.getTime())) {
                document.getElementById('timeSpan').textContent = "Unknown";
                return;
            }
            
            const diffTime = Math.abs(latestDate - earliestDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let timeSpanText = "";
            if (diffDays === 0) {
                timeSpanText = "Same day";
            } else if (diffDays < 30) {
                timeSpanText = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                timeSpanText = `${months} month${months !== 1 ? 's' : ''}`;
            } else {
                const years = Math.floor(diffDays / 365);
                const remainingMonths = Math.floor((diffDays % 365) / 30);
                timeSpanText = `${years} year${years !== 1 ? 's' : ''}`;
                if (remainingMonths > 0) {
                    timeSpanText += `, ${remainingMonths} month${remainingMonths !== 1 ? 's' : ''}`;
                }
            }
            
            document.getElementById('timeSpan').textContent = timeSpanText;
        {% endif %}
    }
    
    function initializeSourcesChart() {
        {% if stats and stats.sources %}
            const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
            
            const sources = Object.keys({{ stats.sources|tojson }});
            const counts = Object.values({{ stats.sources|tojson }});
            
            // Define consistent colors for all sources (softer tones)
            const sourceColorMap = {
                'chatgpt': 'rgba(102, 143, 224, 0.8)',    // Softer blue
                'claude': 'rgba(135, 107, 193, 0.8)',     // Softer purple
                'openwebui': 'rgba(240, 143, 117, 0.8)',  // Softer coral-orange
                'json': 'rgba(102, 143, 224, 0.6)',       // Light blue
                'docx': 'rgba(13, 202, 240, 0.8)',        // Cyan
                'unknown': 'rgba(108, 117, 125, 0.5)'     // Gray
            };

            const backgroundColor = sources.map(source => {
                const sourceLower = source.toLowerCase();
                return sourceColorMap[sourceLower] || sourceColorMap['unknown'];
            });
            
            const sourcesChart = new Chart(sourcesCtx, {
                type: 'pie',
                data: {
                    labels: sources.map(s => s.toLowerCase() === 'chatgpt' ? 'ChatGPT' : s.charAt(0).toUpperCase() + s.slice(1)),
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColor,
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        {% endif %}
    }
    
    function initializeTimelineChart() {
        // Create timeline chart with actual date distribution from histogram data
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');

        {% if stats.timeline %}
            const timelineData = {{ stats.timeline|tojson }};

            // Extract labels (dates)
            const labels = timelineData.map(bucket => {
                const date = new Date(bucket.date);
                return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            });

            // Find all unique sources across all buckets
            const allSources = new Set();
            timelineData.forEach(bucket => {
                Object.keys(bucket).forEach(key => {
                    if (key !== 'date') {
                        allSources.add(key);
                    }
                });
            });

            // Define colors for each source (softer tones, consistent with pie chart)
            const sourceColors = {
                'chatgpt': { bg: 'rgba(102, 143, 224, 0.8)', border: 'rgb(102, 143, 224)' },     // Softer blue
                'claude': { bg: 'rgba(135, 107, 193, 0.8)', border: 'rgb(135, 107, 193)' },      // Softer purple
                'openwebui': { bg: 'rgba(240, 143, 117, 0.8)', border: 'rgb(240, 143, 117)' },   // Softer coral-orange
                'json': { bg: 'rgba(102, 143, 224, 0.6)', border: 'rgb(102, 143, 224)' },        // Light blue
                'docx': { bg: 'rgba(13, 202, 240, 0.8)', border: 'rgb(13, 202, 240)' },          // Cyan
                'unknown': { bg: 'rgba(108, 117, 125, 0.5)', border: 'rgb(108, 117, 125)' }      // Gray
            };

            // Create datasets for each source
            const datasets = Array.from(allSources).sort().map(source => {
                const data = timelineData.map(bucket => bucket[source] || 0);
                const colors = sourceColors[source] || sourceColors['unknown'];

                // Capitalize source name for display
                let displayName = source.charAt(0).toUpperCase() + source.slice(1);
                if (source === 'chatgpt') displayName = 'ChatGPT';
                if (source === 'openwebui') displayName = 'OpenWebUI';

                return {
                    label: displayName,
                    data: data,
                    backgroundColor: colors.bg,
                    borderColor: colors.border,
                    borderWidth: 1
                };
            });
        {% else %}
            const labels = ['No Data'];
            const datasets = [{
                label: 'Conversations',
                data: [0],
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }];
        {% endif %}

        const timelineChart = new Chart(timelineCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        callbacks: {
                            footer: function(tooltipItems) {
                                let sum = 0;
                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += tooltipItem.parsed.y;
                                });
                                return 'Total: ' + (sum === 1 ? '1 conversation' : sum + ' conversations');
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Helper function to format dates nicely
    function formatDateNicely(dateStr) {
        try {
            // Handle different formats
            let date;
            
            // Try parsing different date formats
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}T/)) {
                // ISO format: 2025-03-03T10:01:18
                date = new Date(dateStr);
            } 
            else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                // Format: 2025-03-03 10:01:18
                date = new Date(dateStr.replace(' ', 'T'));
            }
            else if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Format: 2025-03-03
                date = new Date(dateStr);
            }
            else {
                // Unknown format, return as is
                return dateStr;
            }
            
            // If date parsing failed, return original
            if (isNaN(date.getTime())) {
                return dateStr;
            }
            
            // Format the date
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString(undefined, options);
            
        } catch (e) {
            console.error("Error formatting date:", e);
            return dateStr;
        }
    }
</script>
{% endblock %}
